<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <!--
        ===================================================================
        CRON DE ACTUALIZACION DIARIA DE ROTACION DE PRODUCTOS
        ===================================================================

        Este cron ejecuta una actualizacion incremental de los datos de rotacion.

        Estrategia de Ejecucion:
        - Se ejecuta diariamente a las 3:00 AM (configurable)
        - Solo procesa productos con stock o actividad reciente
        - Usa operaciones SQL masivas para eficiencia
        - Tiempo objetivo: < 60 segundos para 15k productos / 300 bodegas

        Detalles Tecnicos:
        - Sin full table scans
        - Usa CTEs para planes de consulta optimizados
        - Patron UPSERT para actualizaciones atomicas
        - Utilizacion correcta de indices

        Monitoreo:
        - Revisar logs para tiempo de ejecucion y conteos
        - Verificar timestamps updated_at en la tabla
        -->
        <record id="ir_cron_product_rotation_daily_update" model="ir.cron">
            <field name="name">Rotacion de Productos: Actualizacion Diaria</field>
            <field name="model_id" ref="model_product_rotation_daily"/>
            <field name="state">code</field>
            <field name="code">model._cron_update_rotation_daily()</field>
            <field name="interval_number">1</field>
            <field name="interval_type">days</field>
            <field name="numbercall">-1</field>
            <field name="doall" eval="False"/>
            <field name="active" eval="True"/>
            <field name="priority">100</field>
            <!-- Programado a las 3:00 AM para evitar horas pico -->
            <field name="nextcall" eval="(datetime.now() + timedelta(days=1)).replace(hour=3, minute=0, second=0).strftime('%Y-%m-%d %H:%M:%S')"/>
        </record>

        <!--
        ===================================================================
        CRON DE LIMPIEZA SEMANAL
        ===================================================================

        Este cron asegura la integridad de datos eliminando registros huerfanos.
        Se ejecuta los domingos a las 4:00 AM.

        Acciones:
        - Elimina registros de productos inactivos/eliminados
        - Elimina registros de bodegas inactivas/eliminadas
        - Ejecuta ANALYZE para optimizar el planificador de consultas
        -->
        <record id="ir_cron_product_rotation_weekly_cleanup" model="ir.cron">
            <field name="name">Rotacion de Productos: Limpieza Semanal</field>
            <field name="model_id" ref="model_product_rotation_daily"/>
            <field name="state">code</field>
            <field name="code">model._cron_weekly_cleanup()</field>
            <field name="interval_number">1</field>
            <field name="interval_type">weeks</field>
            <field name="numbercall">-1</field>
            <field name="doall" eval="False"/>
            <field name="active" eval="True"/>
            <field name="priority">200</field>
            <!-- Programado los domingos a las 4:00 AM -->
            <field name="nextcall" eval="(datetime.now() + timedelta(days=(6 - datetime.now().weekday()) % 7 + 1)).replace(hour=4, minute=0, second=0).strftime('%Y-%m-%d %H:%M:%S')"/>
        </record>

    </data>
</odoo>
