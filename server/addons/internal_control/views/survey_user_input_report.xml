<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="report_survey_user_input_pdf">
    <t t-call="web.basic_layout">
      <!-- CSS personalizado para controlar márgenes de página y tamaño de letra -->
      <style>
        @page {
          margin-top: 10mm;
          margin-bottom: 10mm;
          margin-left: 15mm;
          margin-right: 15mm;
        }
        .page {
          margin: 0;
          padding: 0;
          font-size: 11px !important;
        }
        .page * {
          font-size: 11px !important;
        }
        h1, h2, h3, h4, h5, h6 {
          font-size: 11px !important;
        }
        p, span, div, td, th {
          font-size: 11px !important;
        }
      </style>
      
      <t t-if="docs and len(docs) > 0">
        <t t-set="doc" t-value="docs[0]"/>
        <t t-set="company" t-value="env.company"/>

        <!-- PORTADA - PRIMERA PÁGINA -->
        <div class="page" style="width: 100%; min-height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; background-color: transparent; margin: 0; padding: 40px; page-break-after: always;">
          <div style="width: 100%; max-width: 800px; margin: 300px auto 0 auto; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 20px;">
            <!-- Encabezado -->
            <div style="display: flex; justify-content: space-between; align-items: center; background-color: #F5F5F5; padding: 10px 20px; border-radius: 6px;">
              <!-- Logo alineado a la izquierda -->
              <div style="display: flex; align-items: center;">
                <img t-att-src="'https://farmaciascuxibamba.com.ec/web/image/res.company/%s/logo' % company.id"
                     style="height: 40px; max-width: 150px; object-fit: contain;" alt="Logo"/>
              </div>
            </div>

            <!-- Divisor -->
            <div style="height: 6px; background: linear-gradient(to right, #ffd700 15%, #004aad 15%); margin: 0 0 20px 0;"></div>

            <!-- Información del reporte -->
            <div style="text-align: center; margin: 20px 0;">
              <h2 style="margin: 0 0 15px 0; font-size: 24px; font-weight: bold; color: #333;">
                Reporte de Participación Individual
              </h2>
              <p style="color: #555; margin: 0;">
                Generado el: <t t-out="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y %H:%M')"/>
              </p>
            </div>

            <!-- Información del participante -->
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
              <h4 style="margin-top: 0; color: #333; font-weight: bold;">Información del Participante:</h4>
              <div style="width: 100%;">
                <div style="margin-bottom: 8px;">
                  <span style="color: #555; font-weight: 600; display: inline-block; width: 120px;">Encuesta:</span>
                  <span style="color: #004aad;"><t t-out="doc.survey_id.title"/></span>
                </div>
                <div style="margin-bottom: 8px;">
                  <span style="color: #555; font-weight: 600; display: inline-block; width: 120px;">Participante:</span>
                  <span style="color: #004aad;"><t t-out="doc.partner_id.name or doc.email or doc.nickname or 'Anónimo'"/></span>
                </div>
                <div style="margin-bottom: 8px;">
                  <span style="color: #555; font-weight: 600; display: inline-block; width: 120px;">Estatus:</span>
                  <span style="color: #004aad;"><t t-out="doc.state"/></span>
                </div>
                <div style="margin-bottom: 8px;">
                  <span style="color: #555; font-weight: 600; display: inline-block; width: 120px;">Enviado:</span>
                  <span style="color: #004aad;"><t t-out="doc.end_datetime"/></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SEGUNDA PÁGINA - CONTENIDO -->
        <div class="page" style="margin: 0; padding: 20px; font-family: 'Segoe UI', Arial, sans-serif; background-color: transparent;">
          <div style="width: 100%; max-width: 800px; margin: 0 auto; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 20px;">
            <!-- Encabezado del contenido -->
            <div style="display: flex; justify-content: space-between; align-items: center; background-color: #F5F5F5; padding: 10px 20px; border-radius: 6px;">
              <!-- Logo alineado a la izquierda -->
              <div style="display: flex; align-items: center;">
                <img t-att-src="'https://farmaciascuxibamba.com.ec/web/image/res.company/%s/logo' % company.id"
                     style="height: 40px; max-width: 150px; object-fit: contain;" alt="Logo"/>
              </div>
            </div>

            <!-- Divisor -->
            <div style="height: 6px; background: linear-gradient(to right, #ffd700 15%, #004aad 15%); margin: 0 0 20px 0;"></div>

            <!-- Contenido Principal -->
            <div style="padding: 20px; margin-top: 15px;">
              <h3 style="margin-top: 0; font-weight: bold; color: #333;">Respuestas del Participante:</h3>
              <t t-set="last_section" t-value="''"/>
              
              <t t-foreach="doc.user_input_line_ids.sorted(key=lambda l: l.question_id.page_id.sequence or 0)" t-as="answer">
                <t t-set="current_section" t-value="answer.question_id.page_id.title or 'General'"/>

                <t t-if="current_section != last_section">
                  <hr style="border: none; border-top: 2px solid #ddd; margin: 20px 0;"/>
                  <h4 style="margin: 20px 0; color: #7f8c8d; font-weight: bold;"><t t-esc="current_section"/></h4>
                  <hr style="border: none; border-top: 2px solid #ddd; margin: 20px 0;"/>
                  <t t-set="last_section" t-value="current_section"/>
                </t>

                <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                  <p style="margin: 5px 0; font-weight: bold; color: #333;"><t t-esc="answer.question_id.display_name"/>:</p>
                  <p style="margin: 0; color: #555;">
                    <t t-if="answer.value_text_box">
                      <t t-esc="answer.value_text_box"/>
                    </t>
                    <t t-elif="answer.suggested_answer_id">
                      <t t-esc="answer.suggested_answer_id.display_name"/>
                    </t>
                    <t t-elif="answer.value_numerical_box">
                      <t t-esc="answer.value_numerical_box"/>
                    </t>
                    <t t-else="">
                      -
                    </t>
                  </p>
                  <!-- Mostrar imagen si la respuesta es de tipo archivo y es imagen -->
                  <t t-if="answer.answer_type == 'upload_file' and answer.value_file_data_ids">
                    <div style="margin-top: 10px;">
                      <t t-foreach="answer.value_file_data_ids" t-as="archivo">
                        <t t-if="archivo.mimetype and archivo.mimetype.startswith('image')">
                          <img t-att-src="'/web/content/%s?download=true' % archivo.id" style="max-width: 400px; max-height: 300px; margin-bottom: 5px; border-radius: 5px;"/><br/>
                        </t>
                        <t t-else="">
                          <a t-att-href="'/web/content/%s?download=true' % archivo.id" target="_blank" style="color: #004aad; text-decoration: none;">
                            <t t-esc="archivo.name"/>
                          </a>
                        </t>
                      </t>
                    </div>
                  </t>
                </div>
              </t>
            </div>

            <!-- Tabla resumen de porcentaje de cumplimiento -->
            <div style="margin-top: 40px;">
              <t t-set="category_code" t-value="doc.survey_id.category_id.code if doc.survey_id.category_id else ''"/>
              
              <!-- Para encuestas de cumplimiento -->
              <t t-if="category_code == 'compliance'">
                <h3 style="font-weight: bold; color: #004aad;">Resumen de Cumplimiento</h3>
                <t t-set="cumple_count" t-value="len([l for l in doc.user_input_line_ids if l.suggested_answer_id and (l.suggested_answer_id.value or '').strip().lower() == 'cumple'])"/>
                <t t-set="total_cumplimiento" t-value="len([l for l in doc.user_input_line_ids if l.suggested_answer_id and (l.suggested_answer_id.value or '').strip().lower() in ['cumple', 'no cumple', 'no_cumple']])"/>
                <t t-set="porcentaje" t-value="(cumple_count / total_cumplimiento * 100) if total_cumplimiento else 0"/>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                  <thead>
                    <tr style="background-color: #f8f9fa; border: 1px solid #ddd;">
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Total Preguntas de Cumplimiento</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Respuestas "Cumple"</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">% Cumplimiento</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="total_cumplimiento"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="cumple_count"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="'%.1f' % porcentaje"/>%</td>
                    </tr>
                  </tbody>
                </table>
              </t>
              
              <!-- Para encuestas de items revisados -->
              <t t-elif="category_code == 'revision_items'">
                <h3 style="font-weight: bold; color: #004aad;">Resumen de Items Revisados</h3>
                <t t-set="total_revisados" t-value="sum([float(l.value_numerical_box or 0) for l in doc.user_input_line_ids if l.question_id.question_type == 'numerical_box' and l.question_id.title and 'revisados' in l.question_id.title.lower() and 'sin novedad' not in l.question_id.title.lower()])"/>
                <t t-set="total_sin_novedad" t-value="sum([float(l.value_numerical_box or 0) for l in doc.user_input_line_ids if l.question_id.question_type == 'numerical_box' and l.question_id.title and 'revisados' in l.question_id.title.lower() and 'sin novedad' in l.question_id.title.lower()])"/>
                <t t-set="porcentaje_sin_novedad" t-value="(total_sin_novedad / total_revisados * 100) if total_revisados else 0"/>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                  <thead>
                    <tr style="background-color: #f8f9fa; border: 1px solid #ddd;">
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Total Items Revisados</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Items Sin Novedad</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">% Sin Novedad</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="int(total_revisados)"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="int(total_sin_novedad)"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="'%.1f' % porcentaje_sin_novedad"/>%</td>
                    </tr>
                  </tbody>
                </table>
              </t>
              
              <!-- Para encuestas de satisfacción -->
              <t t-elif="category_code == 'satisfaction'">
                <h3 style="font-weight: bold; color: #004aad;">Resumen de Satisfacción</h3>
                <t t-set="respuestas_satisfaccion" t-value="[l for l in doc.user_input_line_ids if l.suggested_answer_id and l.suggested_answer_id.value]"/>
                <t t-set="total_respuestas" t-value="len(respuestas_satisfaccion)"/>
                <t t-set="promedio_satisfaccion" t-value="sum([float(l.suggested_answer_id.value) for l in respuestas_satisfaccion if l.suggested_answer_id.value.isdigit()]) / total_respuestas if total_respuestas else 0"/>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                  <thead>
                    <tr style="background-color: #f8f9fa; border: 1px solid #ddd;">
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Total Preguntas de Satisfacción</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Promedio de Satisfacción</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Nivel de Satisfacción</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="total_respuestas"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="'%.1f' % promedio_satisfaccion"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">
                        <t t-if="promedio_satisfaccion >= 4.0">Alto</t>
                        <t t-elif="promedio_satisfaccion >= 3.0">Medio</t>
                        <t t-else="">Bajo</t>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </t>
              
              <!-- Para encuestas de participación -->
              <t t-elif="category_code == 'participation'">
                <h3 style="font-weight: bold; color: #004aad;">Resumen de Participación</h3>
                <t t-set="respuestas_si" t-value="len([l for l in doc.user_input_line_ids if l.suggested_answer_id and (l.suggested_answer_id.value or '').strip().lower() == 'sí'])"/>
                <t t-set="respuestas_no" t-value="len([l for l in doc.user_input_line_ids if l.suggested_answer_id and (l.suggested_answer_id.value or '').strip().lower() == 'no'])"/>
                <t t-set="total_participacion" t-value="respuestas_si + respuestas_no"/>
                <t t-set="porcentaje_participacion" t-value="(respuestas_si / total_participacion * 100) if total_participacion else 0"/>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                  <thead>
                    <tr style="background-color: #f8f9fa; border: 1px solid #ddd;">
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Total Preguntas de Participación</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Respuestas "Sí"</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">% Participación</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="total_participacion"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="respuestas_si"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="'%.1f' % porcentaje_participacion"/>%</td>
                    </tr>
                  </tbody>
                </table>
              </t>
              
              <!-- Para encuestas sin categoría o categoría no reconocida -->
              <t t-else="">
                <h3 style="font-weight: bold; color: #004aad;">Resumen de Respuestas</h3>
                <t t-set="total_respuestas" t-value="len(doc.user_input_line_ids)"/>
                <t t-set="respuestas_completadas" t-value="len([l for l in doc.user_input_line_ids if l.value_text_box or l.suggested_answer_id or l.value_numerical_box])"/>
                <t t-set="porcentaje_completado" t-value="(respuestas_completadas / total_respuestas * 100) if total_respuestas else 0"/>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                  <thead>
                    <tr style="background-color: #f8f9fa; border: 1px solid #ddd;">
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Total Preguntas</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">Respuestas Completadas</th>
                      <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; vertical-align: middle;">% Completado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="total_respuestas"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="respuestas_completadas"/></td>
                      <td style="border: 1px solid #ddd; padding: 12px; text-align: center;"><t t-esc="'%.1f' % porcentaje_completado"/>%</td>
                    </tr>
                  </tbody>
                </table>
              </t>
            </div>

            <!-- Footer -->
            <div style="border-top: 1px solid #ddd; margin-top: 40px; padding-top: 15px; text-align: center; font-size: 12px; color: #555;">
              <p style="margin: 0 0 5px 0;">Reporte generado por Control Interno - Farmacias Cuxibamba</p>
              <p style="margin: 0;">Tel: +593 96 066 2194 | www.farmaciascuxibamba.com.ec</p>
            </div>
          </div>
        </div>
      </t>
    </t>
  </template>

  <record id="action_report_survey_user_input" model="ir.actions.report">
    <field name="name">Survey Response PDF</field>
    <field name="model">survey.user_input</field>
    <field name="report_type">qweb-pdf</field>
    <field name="report_name">internal_control.report_survey_user_input_pdf</field>
    <field name="report_file">internal_control.report_survey_user_input_pdf</field>
    <field name="print_report_name">'Reporte Respuesta Individual - %s - %s' % (object.survey_id.title or 'Encuesta', object.partner_id.name or 'Anónimo')</field>
    <field name="binding_model_id" ref="model_survey_user_input"/>
    <field name="binding_type">report</field>
  </record>
</odoo>