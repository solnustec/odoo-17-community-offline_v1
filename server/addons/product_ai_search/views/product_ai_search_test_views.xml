<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Formulario de Prueba de B√∫squeda -->
    <record id="view_product_ai_search_test_form" model="ir.ui.view">
        <field name="name">product.ai.search.test.form</field>
        <field name="model">product.ai.search.test</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button string="üîç Buscar" name="action_search" type="object" class="btn-primary"/>
                    <button string="üßπ Limpiar" name="action_clear_results" type="object" class="btn-warning" 
                            invisible="not search_executed"/>
                    <button string="üìä Verificar Estado" name="action_check_status" type="object" class="btn-info"/>
                    <button string="‚ö° Indexar Productos (Prueba)" name="action_index_products" type="object" class="btn-secondary"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>üîç Prueba de B√∫squeda IA para Productos</h1>
                    </div>
                    
                    <group>
                        <group string="üîß Par√°metros de B√∫squeda">
                            <field name="search_type" widget="radio" string="Tipo de B√∫squeda"/>
                            <field name="search_query" placeholder="Escriba su b√∫squeda en espa√±ol..." invisible="search_type == 'prescription'" string="üîç Consulta de B√∫squeda"/>
                            <field name="max_results" invisible="search_type == 'answer' or search_type == 'prescription'" string="üìä M√°ximo de Resultados"/>
                        </group>
                        
                        <group string="üìä Estat√≠sticas" invisible="not search_executed">
                            <field name="search_executed" invisible="1"/>
                            <field name="total_results" readonly="1" string="üéØ Total de Resultados"/>
                            <field name="search_time" readonly="1" string="‚è±Ô∏è Tempo de Busca (seg)"/>
                        </group>
                    </group>

                    <!-- Se√ß√£o de An√°lise de Receita M√©dica -->
                    <group string="üè• An√°lisis de Receta M√©dica" invisible="search_type != 'prescription'">
                        <div class="alert alert-info" role="alert" style="margin: 10px 0;">
                            <h4 style="margin-top: 0;"><i class="fa fa-info-circle"></i> Instrucciones</h4>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li style="margin: 4px 0;">Suba una imagen clara de la receta m√©dica</li>
                                <li style="margin: 4px 0;">Formatos aceptados: JPEG, PNG, WEBP (m√°ximo 20MB)</li>
                                <li style="margin: 4px 0;">La IA analizar√° y buscar√° productos correspondientes</li>
                            </ul>
                        </div>
                        
                        <group string="üìÅ Subir Imagen">
                            <field name="prescription_image" widget="binary" filename="prescription_filename" 
                                   string="Imagen de la Receta" 
                                   options="{'accepted_file_extensions': '.jpg,.jpeg,.png,.webp'}"/>
                            <field name="prescription_filename" invisible="1"/>
                            <field name="prescription_top_k" string="M√°ximo de productos por medicamento"/>
                            <field name="prescription_analysis_only" invisible="1"/>
                        </group>
                    </group>
                    
                    <!-- Respuesta IA -->
                    <group string="üí¨ Respuesta IA" invisible="search_type != 'answer' or not ai_answer">
                        <field name="ai_answer" nolabel="1" readonly="1" widget="text"/>
                    </group>
                    
                    <!-- Resultados de la B√∫squeda -->
                    <notebook invisible="search_type == 'answer' or (total_results == 0 and search_type != 'prescription')">
                        <page string="üìã Resultados de la B√∫squeda" name="results">
                            <div class="alert alert-success" role="alert" style="margin: 10px 0;">
                                <h4 style="margin-top: 0;"><i class="fa fa-list"></i> Productos Encontrados</h4>
                                <p style="margin-bottom: 0;">Total de productos encontrados: <strong><field name="total_results" readonly="1"/></strong></p>
                            </div>
                            
                            <field name="result_ids" nolabel="1" readonly="1" 
                                   context="{'reload_on_save': True}"
                                   options="{'reload_on_save': True}">
                                <tree create="false" edit="false" delete="false" decoration-info="ai_score &gt; 0.8" decoration-warning="ai_score &lt; 0.5">
                                    <field name="rank" width="60px" string="#"/>
                                    <field name="product_name" string="Producto"/>
                                    <field name="default_code" string="C√≥digo" width="100px"/>
                                    <field name="category_name" string="Categor√≠a"/>
                                    <field name="list_price" string="Precio" widget="monetary"/>
                                    <field name="ai_score" string="Score IA" widget="progressbar" digits="[16,3]"/>
                                    <button name="action_open_product" type="object" icon="fa-external-link" 
                                            title="Abrir Producto" class="btn-primary btn-sm"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                    
                    <!-- Instrucciones de Uso -->
                    <div class="mt16" invisible="search_executed">
                        <h3>üí° C√≥mo usar:</h3>
                        <ul>
                            <li><strong>Buscar Productos:</strong> Escriba una descripci√≥n en espa√±ol</li>
                            <li><strong>Pregunta con Respuesta IA:</strong> Realice una pregunta</li>
                            <li><strong>Indexar Productos:</strong> Ejecute primero si es la primera vez</li>
                            <li><strong>Verificar Estado:</strong> Confirme si el √≠ndice est√° funcionando</li>
                        </ul>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Acci√≥n para abrir prueba de b√∫squeda -->
    <record id="action_product_ai_search_test" model="ir.actions.act_window">
        <field name="name">Prueba de B√∫squeda IA</field>
        <field name="res_model">product.ai.search.test</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>
</odoo>
