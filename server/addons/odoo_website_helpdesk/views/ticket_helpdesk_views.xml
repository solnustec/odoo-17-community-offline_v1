<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Form view -->
    <record id="helpdesk_ticket_view_quick_create_form" model="ir.ui.view">
        <field name="model">ticket.helpdesk</field>
        <field name="arch" type="xml">
            <form>
                <group>
                    <field name="user_id" options="{'no_open': True, 'no_create': True}" readonly="1"/>
                    <field name="subject"/>
                    <field name="description"/>
                    <field name="company_id" invisible="1"/>
                </group>
            </form>
        </field>
    </record>

    <record id="ticket_helpdesk_view_form" model="ir.ui.view">
        <field name="name">ticket.helpdesk.view.form</field>
        <field name="model">ticket.helpdesk</field>
        <field name="priority">1</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_send_reply" string="Comunicarse" type="object" class="btn-primary"/>
                    <field name="stage_closing" invisible="1"/>
                    <button name="%(report_ticket_full)d" string="Imprimir Reporte Completo" type="action" class="btn-primary"/>
                    <field name="stage_id" widget="statusbar" options="{'clickable': '1'}" readonly="id == False" groups="odoo_website_helpdesk.helpdesk_manager,odoo_website_helpdesk.helpdesk_assigned_user"/>
                    <field name="stage_id" widget="statusbar" options="{'clickable': '1'}" readonly="1" groups="odoo_website_helpdesk.helpdesk_employee"/>/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <group class="row">
                            <group class="col-6">
                                <label for="name" class="oe_edit_only"/>
                                <h1>
                                    <field name="name" readonly="1"/>
                                </h1>
                            </group>
                            <group class="col-6">
                                <field name="kanban_state" widget="state_selection_widget" invisible="stage_closing != True"/>
                            </group>
                        </group>
                        <group>
                            <label for="subject" class="oe_edit_only"/>
                            <h1 class="mt0">
                                <field name="subject"/>
                            </h1>
                        </group>
                    </div>
                    <group>
                        <group>
                            <field name="user_id" readonly="1"/>
                            <field name="user_vat" string="Cédula / Pasaporte"/>
                            <field name="user_email" string="Correo"/>
                            <field name="user_phone" string="Celular"/>
                            <field name="department_id"/>
                            <field name="company_id"/>
                            <field name="job_id"/>
                            <field name="last_update_date" readonly="1"/>
                        </group>
                        <group>
                            <field name="area_id" options="{'no_create': True, 'no_open': True}"/>
                            <field name="subarea_id"
                                   options="{'no_create': True, 'no_open': True}"
                                   context="{'default_area_id': area_id}"
                                   required="area_id != False"
                                   domain="[('area_id', '=?', area_id)]"/>
                            <field name="nro_de_serie"
                                   invisible="not is_serial_number_required"
                                   required="is_serial_number_required"/>
                            <field name="is_serial_number_required" invisible="1"/>
                            <field name="ticket_type_id"
                                   groups="odoo_website_helpdesk.helpdesk_manager, odoo_website_helpdesk.helpdesk_assigned_user"
                                   />
                            <field name="ticket_type_id" readonly="1" options="{'no_open': True}"
                                   groups="odoo_website_helpdesk.helpdesk_employee"/>

                            <field name="priority" widget="priority"
                                   groups="odoo_website_helpdesk.helpdesk_manager"
                                   />
                            <field name="priority" widget="priority" readonly="1"
                                   groups="odoo_website_helpdesk.helpdesk_employee, odoo_website_helpdesk.helpdesk_assigned_user"/>

                            <field name="create_date" readonly="True"/>
                            <field name="start_date" readonly="True" invisible="start_date == False"/>
                            <field name="waiting_date" readonly="True" invisible="waiting_date == False"/>
                            <field name="end_date" readonly="True" invisible="end_date == False"/>
                            <field name="canceled_date" readonly="True" invisible="canceled_date == False"/>
                            <field name="approved" string="Ticket Aprobado" groups="odoo_website_helpdesk.helpdesk_manager, odoo_website_helpdesk.helpdesk_assigned_user"/>
                            <field name="show_mantenimiento" groups="odoo_website_helpdesk.helpdesk_manager, odoo_website_helpdesk.helpdesk_assigned_user"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Descripción del problema">
                            <field name="description" placeholder="Provide the reason in detail"/>
                        </page>
                        <page string="Archivos adjuntos">
                            <field name="attachment_ids" readonly="1">
                                <tree string="Archivos Subidos">
                                    <field name="name" string="Nombre del archivo"/>
                                    <field name="create_date" string="Fecha de subida"/>
                                    <field name="create_uid" string="Subido por"/>
                                    <button name="unlink" string="Eliminar" type="object" class="btn-danger"
                                            confirm="¿Está seguro de que desea eliminar este archivo?" icon="fa-trash"/>
                                </tree>
                            </field>
                            <group col="1">
                                <button name="action_upload_attachment" string="Subir archivo" type="object" class="oe_highlight" icon="fa-upload"/>
                            </group>
                        </page>
                        <page string="Asignación" name="assignment_tab" groups="odoo_website_helpdesk.helpdesk_manager">
                            <group>
                                <field name="assigned_user_ids" widget="many2many_tags" options="{'no_create': True}"/>
                                <field name="assignable_user_ids" invisible="1"/>
                                <field name="category_id" invisible="1"/>
                            </group>
                        </page>
                        <page string="Descripción del Técnico">
                            <group>
                                <field name="description_technical" placeholder="Descripción de parte del Técnico" readonly="1" groups="odoo_website_helpdesk.helpdesk_employee"/>
                                <field name="description_technical" placeholder="Descripción de parte del Técnico" groups="odoo_website_helpdesk.helpdesk_manager, odoo_website_helpdesk.helpdesk_assigned_user"/>
                                <field name="technical_attachment_ids" readonly="1" groups="odoo_website_helpdesk.helpdesk_manager, odoo_website_helpdesk.helpdesk_assigned_user">
                                    <tree string="Archivos Técnicos">
                                        <field name="name" string="Nombre del archivo"/>
                                        <field name="create_date" string="Fecha de subida"/>
                                        <field name="create_uid" string="Subido por"/>
                                        <button name="unlink" string="Eliminar" type="object" class="btn-danger"
                                                confirm="¿Está seguro de que desea eliminar este archivo?" icon="fa-trash"
                                                groups="odoo_website_helpdesk.helpdesk_manager, odoo_website_helpdesk.helpdesk_assigned_user"/>
                                    </tree>
                                </field>
                                <group col="1" groups="odoo_website_helpdesk.helpdesk_manager, odoo_website_helpdesk.helpdesk_assigned_user">
                                    <button name="action_upload_technical_attachment" string="Subir archivo" type="object" class="oe_highlight" icon="fa-upload"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="o_attachment_preview"/>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>
    <!--Tree view-->
    <record id="ticket_helpdesk_view_tree" model="ir.ui.view">
        <field name="name">ticket.helpdesk.view.tree</field>
        <field name="model">ticket.helpdesk</field>
        <field name="arch" type="xml">
            <tree>
                <field name="create_date" filter_domain="[]"/>
                <field name="name"/>
                <field name="customer_id"/>
                <field name="assigned_user_ids" widget="many2many_tags"/>
                <field name="subject"/>
                <field name="stage_id" string="Estado"/>
                <field name="stage_closing" string="¿Etapa de Cierre?"/>
                <button name="%(report_ticket_full)d" string="Reporte" type="action" class="btn-primary"/>
            </tree>
        </field>
    </record>
    <!-- Kanban view -->
    <record id="ticket_helpdesk_view_kanban" model="ir.ui.view">
        <field name="name">ticket.helpdesk.view.kanban</field>
        <field name="model">ticket.helpdesk</field>
        <field name="arch" type="xml">
            <kanban default_group_by="stage_id" class="o_kanban_small_column" quick_create="0">
                <field name="color"/>
                <field name="name"/>
                <field name="stage_id" readonly="1"/>
                <field name="kanban_state"/>
                <field name="stage_closing"/>
                <progressbar field="kanban_state" colors='{"pending_validation": "warning", "validated": "success"}'/>
                <templates>
                    <t t-name="kanban-menu">
                        <t t-if="widget.editable">
                            <a role="menuitem" type="edit" class="dropdown-item">Edit</a>
                        </t>
                        <t t-if="widget.deletable">
                            <a role="menuitem" type="delete" class="dropdown-item">Delete</a>
                        </t>
                        <ul class="oe_kanban_colorpicker" data-field="color"/>
                    </t>
                    <t t-name="kanban-box">
                        <div t-attf-class="#{!selection_mode ? kanban_color(record.color.raw_value) : ''} #{lost_ribbon ? 'oe_kanban_card_ribbon' : ''} oe_kanban_global_click oe_kanban_card d-flex flex-column"
                             t-attf-style="background-color: #{record.kanban_state == 'validated' ? '#dff0d8' : (record.kanban_state == 'pending_validation' ? '#fcf8e3' : '')};">
                            <div t-attf-class="o_kanban_card_header">
                                <div class="oe_kanban_content position-relative">
                                    <div class="row">
                                        <div class="col">
                                            <strong>
                                                <field name="name"/>
                                            </strong>
                                        </div>
                                    </div>
                                    <div class="text-muted">
                                        <field name="customer_id"/>
                                    </div>
                                    <div class="position-absolute top-0 end-0" style="margin-top: 5px; margin-right: 5px;">
                                        <button name="%(report_ticket_full)d" string="Reporte" type="action" class="btn-primary"/>
                                    </div>
                                    <div class="o_kanban_record_bottom flex-wrap d-flex justify-content-between align-items-center">
                                        <div class="oe_kanban_bottom_left">
                                            <field name="priority" widget="priority" readonly="1"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    <!-- Activity view -->
    <record id="helpdesk_ticket_view_activity" model="ir.ui.view">
        <field name="name">ticket.helpdesk.view.activity</field>
        <field name="model">ticket.helpdesk</field>
        <field name="arch" type="xml">
            <activity string="Tickets">
                <templates>
                    <div t-name="activity-box">
                        <div>
                            <field name="name" display="full"/>
                            <field name="customer_id" muted="1" display="full"/>
                        </div>
                    </div>
                </templates>
            </activity>
        </field>
    </record>
    <!-- Calendar view -->
    <record id="ticket_helpdesk_view_calendar" model="ir.ui.view">
        <field name="name">ticket.helpdesk.view.calendar</field>
        <field name="model">ticket.helpdesk</field>
        <field name="arch" type="xml">
            <calendar string="Helpdesk Ticket" date_start="create_date" date_stop="end_date" event_open_popup="true" mode="month" color="customer_id" quick_create="0">
                <field name="customer_id"/>
                <field name="subject"/>
            </calendar>
        </field>
    </record>

    <!-- Pivot view -->
    <record id="help_ticket_view_pivot" model="ir.ui.view">
        <field name="name">ticket.helpdesk.pivot</field>
        <field name="model">ticket.helpdesk</field>
        <field name="arch" type="xml">
            <pivot>
                <field name="customer_id" type="col"/>
                <field name="subject" type="row"/>
                <field name="customer_name" type="col"/>
                <field name="email"/>
                <field name="phone"/>
                <field name="start_date"/>
            </pivot>
        </field>
    </record>
    <!-- Graph view -->
    <record id="help_ticket_view_graph" model="ir.ui.view">
        <field name="name">ticket.helpdesk.graph</field>
        <field name="model">ticket.helpdesk</field>
        <field name="arch" type="xml">
            <graph>
                <field name="customer_id"/>
                <field name="subject"/>
                <field name="customer_name"/>
                <field name="email"/>
                <field name="phone"/>
                <field name="start_date"/>
            </graph>
        </field>
    </record>
    <!-- Search view -->
    <record id="help_ticket_search" model="ir.ui.view">
        <field name="name">ticket.helpdesk.search</field>
        <field name="model">ticket.helpdesk</field>
        <field name="arch" type="xml">
            <search string="Búsqueda de Ticket">
                <!-- Searchable fields -->
                <field name="name" string="Ticket"/>
                <field name="subject"/>
                <field name="customer_id"/>
                <field name="assigned_user_ids"/>
                <field name="stage_id"/>
                <field name="priority"/>
                <field name="ticket_type_id"/>
                <field name="nro_de_serie"/>

                <!-- Filters -->
                <filter string="Tickets Abiertos" name="filter_open" domain="[('stage_closing','=', False)]"/>
                <filter string="Tickets Cerrados" name="filter_closed" domain="[('stage_closing','=', True)]"/>
                <filter string="Prioridad Muy Alta" name="filter_high_priority" domain="[('priority','=','4')]" groups="odoo_website_helpdesk.helpdesk_manager,odoo_website_helpdesk.helpdesk_assigned_user"/>
                <filter string="Asignados a Mi" name="filter_assigned_to_me" domain="[('assigned_user_ids','=',uid)]" groups="odoo_website_helpdesk.helpdesk_manager,odoo_website_helpdesk.helpdesk_assigned_user"/>
                <filter string="Tickets Recientes (7 dias)" name="filter_recent" domain="[('create_date','>=', (context_today() - relativedelta(days=7)).strftime('%Y-%m-%d'))]"/>

                <!-- Group By -->
                <group expand="0" string="Agrupar por">
                    <filter name="Customer" string="Cliente" context="{'group_by':'customer_id'}"/>
                    <filter name="Assigned" string="Asignado a" context="{'group_by':'assigned_user_ids'}"/>
                    <filter name="Stage" string="Estado" context="{'group_by':'stage_id'}"/>
                    <filter name="Priority" string="Prioridad" context="{'group_by':'priority'}"/>
                    <filter name="Ticket Type" string="Tipo de Ticket" context="{'group_by':'ticket_type_id'}"/>
                    <filter name="Serial Number" string="Número de Serie" context="{'group_by':'nro_de_serie'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action for ticket helpdesk model -->
    <record id="ticket_helpdesk_action_report" model="ir.actions.act_window">
        <field name="name">Mesa de ayuda para informes</field>
        <field name="res_model">ticket.helpdesk</field>
        <field name="view_mode">graph,search</field>
    </record>
    <!-- Define the action for the general Helpdesk view -->
    <record id="ticket_helpdesk_action" model="ir.actions.act_window">
        <field name="name">Soporte Técnico</field>
        <field name="res_model">ticket.helpdesk</field>
        <field name="view_mode">tree,kanban,form,calendar,graph</field>
    </record>

    <!-- Define the action for the My Helpdesk view with a specific domain -->
    <record id="ticket_helpdesk_action_my" model="ir.actions.act_window">
        <field name="name">Mis soportes técnicos</field>
        <field name="res_model">ticket.helpdesk</field>
        <field name="domain">['|', ('assigned_user_ids', 'in', [uid]), ('user_id', '=', uid)]</field>
        <field name="view_mode">tree,kanban,form,calendar,graph</field>
    </record>
</odoo>